{% extends "auction/layout.html" %}
{% block body %}

<!-- Include Bootstrap CDN -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Custom Styles -->
<style>
    .background-gavel {
        background-image: url("/static/image.png"); /* Adjust the path as needed */
        background-repeat: no-repeat;
        background-size: contain;
        background-position: center;
        opacity: 0.05;
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        z-index: -1;
        pointer-events: none;
    }

    textarea {
        resize: none;
    }

    .listing-img {
        height: 250px;
        object-fit: contain;
    }

    .section-title {
        font-weight: 600;
        color: #0d6efd;
    }

    /* ðŸ”§ Fix comment overflow */
    .list-group-item {
        word-wrap: break-word;
        word-break: break-word;
        white-space: normal;
    }

    /* Optional: Improve button spacing */
    form button {
        margin-top: 8px;
    }
    .fade-toggle {
        transition: all 0.4s ease;
        max-height: 0;
        overflow: hidden;
        opacity: 0;
    }
    
    .fade-toggle.show {
        max-height: 500px; /* enough for long content */
        opacity: 1;
    }
    
</style>

<!-- Background Image -->
<div class="background-gavel"></div>

<div class="container my-5">
    <div class="row">
        <!-- Left Column: Listing Details -->
        <div class="col-lg-5 mb-4">
            <h2 class="section-title">{{ listing.title }}</h2>

            {% if listing.imageUrl %}
                <img src="{{ listing.imageUrl }}" class="img-fluid rounded shadow mb-3 listing-img" alt="Listing Image">
            {% endif %}

            {% if message %}
                <div class="alert alert-{{ message_type }}">{{ message }}</div>
            {% endif %}

            <ul class="list-group mb-3">
                <li class="list-group-item">
                    <strong>Description:</strong>
                    <span id="desc-preview">{{ listing.description|truncatechars:150 }}</span>
                    <div id="desc-full" class="fade-toggle mt-1">
                        {{ listing.description }}
                    </div>
                    {% if listing.description|length > 150 %}
                        <br>
                        <button class="btn btn-sm btn-link p-0" onclick="toggleDescription()" id="toggle-btn">Read more</button>
                    {% endif %}
                </li>
                {% if is_creator and listing.isPrivate %}
                    <li class="list-group-item"><strong>Room Id:</strong> {{ listing.room_id }}</li>
                {% endif %}       
                <li class="list-group-item"><strong>Category:</strong> {{ listing.category }}</li>
                <li class="list-group-item"><strong>Created by:</strong> {{ listing.owner }}</li>
                <li class="list-group-item"><strong>Current Price:</strong> ${{ listing.current_price }}</li>
                {% if highest_bid %}
                    <li class="list-group-item text-success"><strong>Highest Bidder:</strong> {{ highest_bid.user }}</li>
                {% endif %}
            </ul>

            {% if user.is_authenticated %}
                <form method="post">
                    {% csrf_token %}
                    <button name="watchlist_toggle" class="btn btn-outline-dark w-100">
                        {% if in_watchlist %}
                            Remove from Watchlist
                        {% else %}
                            Add to Watchlist
                        {% endif %}
                    </button>
                </form>
            {% endif %}

            {% if listing.isActive %}
                {% if user.is_authenticated and not is_creator %}
                    <form method="post" onsubmit="return validateBid();">
                        {% csrf_token %}
                        <div class="input-group">
                            <input type="number" id="bidInput" name="bid" class="form-control" step="0.01" min="0" placeholder="Your bid" required>
                            <button name="place_bid" class="btn btn-primary">Place Bid</button>
                        </div>
                    </form>
                {% endif %}
            {% else %}
                <div class="alert alert-danger">This Auction is over.</div>
            {% endif %}

            {% if user.is_authenticated and is_creator and listing.isActive %}
                <form method="post">
                    {% csrf_token %}
                    <button name="close_auction" class="btn btn-danger w-100">Close Auction</button>
                </form>
            {% endif %}

            {% if user.is_authenticated and winner and is_winner %}
                <div class="alert alert-success text-center">ðŸŽ‰ You won the Auction!</div>
            {% endif %}
        </div>

        <!-- Right Column: Comments -->
        <div class="col-lg-7">
            <h4 class="section-title mb-3">Comments</h4>

            {% if user.is_authenticated %}
                <form method="post" class="mb-4">
                    {% csrf_token %}
                    <textarea name="comment" class="form-control mb-2" rows="3" placeholder="Write a comment..." required></textarea>
                    <button name="comment_submit" class="btn btn-success">Add Comment</button>
                </form>
            {% endif %}

            <ul class="list-group">
                {% for comment in comments %}
                <div class="mb-3">
                    <strong>{{ comment.user }}</strong><br>
                    {% if comment.content|length > 150 %}
                        <span id="comment-preview-{{ forloop.counter }}">
                            {{ comment.content|truncatechars:150 }}
                        </span>
                        <div id="comment-full-{{ forloop.counter }}" class="fade-toggle mt-1">
                            {{ comment.content }}
                        </div>
                        <br>
                        <button class="btn btn-sm btn-link p-0" onclick="toggleComment('{{ forloop.counter }}')" id="comment-btn-{{ forloop.counter }}">Read more</button>
                    {% else %}
                        <span>{{ comment.content }}</span>
                    {% endif %}
                </div>
                {% empty %}
                    <p>No comments yet.</p>
                {% endfor %}
                
            
            </ul>
        </div>
    </div>
</div>

<!-- Script for Bid Validation -->
<script>
    function validateBid() {
        const input = document.getElementById('bidInput');
        const value = parseFloat(input.value);
        if (!value || value <= 0) {
            alert("Please enter a valid bid greater than 0.");
            return false;
        }
        return true;
    }
    function toggleDescription() {
        const preview = document.getElementById('desc-preview');
        const full = document.getElementById('desc-full');
        const button = document.getElementById('toggle-btn');
    
        const isOpen = full.classList.contains("show");
    
        if (isOpen) {
            preview.style.display = "inline";
            full.classList.remove("show");
            button.innerText = "Read more";
        } else {
            preview.style.display = "none";
            full.classList.add("show");
            button.innerText = "Read less";
        }
    }
    
    function toggleComment(id) {
        const preview = document.getElementById(`comment-preview-${id}`);
        const full = document.getElementById(`comment-full-${id}`);
        const button = document.getElementById(`comment-btn-${id}`);
    
        const isOpen = full.classList.contains("show");
    
        if (isOpen) {
            preview.style.display = "inline";
            full.classList.remove("show");
            button.innerText = "Read more";
        } else {
            preview.style.display = "none";
            full.classList.add("show");
            button.innerText = "Read less";
        }
    }
    
    
</script>

{% endblock %}
